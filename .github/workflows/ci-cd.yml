name: CI/CD Pipeline

on:
  push:
    branches: [ main, gcp-deploy-win, final-monitor1 ]
  pull_request:
    branches: [ main, gcp-deploy-win, final-monitor1 ]

env:
  NODE_VERSION: '20'
  PROJECT_ID: 'mqi-ims'
  GAE_SERVICE: 'default'
  INSTANCE_NAME: 'product-management-db'

jobs:
  # Lint and Test Job
  test:
    name: ğŸ§ª Test & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ” Run linting
      run: |
        if [ -f "package.json" ] && grep -q "lint" package.json; then
          npm run lint
        else
          echo "No lint script found, skipping..."
        fi
      continue-on-error: true
      
    - name: ğŸ§ª Run tests
      run: |
        if [ -f "package.json" ] && grep -q "test" package.json; then
          npm test
        else
          echo "No test script found, skipping..."
        fi
      continue-on-error: true
      
    - name: ğŸ”’ Security audit
      run: npm audit --audit-level moderate
      continue-on-error: true

  # Database Schema Validation
  validate-schema:
    name: ğŸ—„ï¸ Validate Database Schema
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ” Validate SQL files
      run: |
        echo "Checking SQL files syntax..."
        for file in sql/*.sql; do
          if [ -f "$file" ]; then
            echo "Validating $file"
            # Basic SQL syntax validation (could be enhanced with actual SQL linter)
            if grep -q "DROP\s\+DATABASE\|TRUNCATE\s\+TABLE\|DELETE\s\+FROM.*WHERE.*1=1" "$file"; then
              echo "âš ï¸ Warning: Potentially dangerous SQL command found in $file"
            fi
          fi
        done
        
    - name: ğŸ§ª Test database setup script
      run: |
        echo "Testing database setup script syntax..."
        node -c setup-db.js
        echo "âœ… Database setup script syntax is valid"

  # Check required secrets before deployment
  check-secrets:
    name: ğŸ” Validate Required Secrets
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/gcp-deploy-win' || github.ref == 'refs/heads/final-monitor1' || github.ref == 'refs/heads/main'
    outputs:
      secrets-available: ${{ steps.check.outputs.secrets-available }}
    
    steps:
    - name: ğŸ“‹ Check for required secrets
      id: check
      run: |
        echo "Checking for required GitHub secrets..."
        if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
          echo "âŒ Missing GCP_SA_KEY secret"
          echo "secrets-available=false" >> $GITHUB_OUTPUT
          echo "::error::Missing required secret: GCP_SA_KEY"
          echo "::error::Please add Google Cloud Service Account key as GCP_SA_KEY secret"
          echo "::error::Visit: https://github.com/${{ github.repository }}/settings/secrets/actions"
          exit 1
        else
          echo "âœ… GCP_SA_KEY secret is configured"
          echo "secrets-available=true" >> $GITHUB_OUTPUT
        fi

  # Build and Deploy to Development (on feature branches)
  deploy-dev:
    name: ğŸš€ Deploy to Development
    runs-on: ubuntu-latest
    needs: [test, validate-schema, check-secrets]
    if: github.ref == 'refs/heads/gcp-deploy-win' && github.event_name == 'push' && needs.check-secrets.outputs.secrets-available == 'true'
    environment: development
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci --only=production
      
    - name: ğŸ”§ Setup environment variables
      run: |
        echo "NODE_ENV=development" >> .env
        echo "DB_HOST=/cloudsql/${{ env.PROJECT_ID }}:us-central1:${{ env.INSTANCE_NAME }}" >> .env
        # Use default credentials if secrets are not set
        echo "DB_USER=sigma" >> .env
        echo "DB_PASSWORD=sigma" >> .env
        echo "DB_NAME=product_management_system" >> .env
        
    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
        
    - name: â˜ï¸ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        
    - name: ğŸš€ Deploy to App Engine Development
      run: |
        # Create development app.yaml with explicit configuration
        cat > app-dev.yaml << EOF
        runtime: nodejs20
        service: dev
        
        env_variables:
          NODE_ENV: 'development'
          DB_HOST: '/cloudsql/${{ env.PROJECT_ID }}:us-central1:${{ env.INSTANCE_NAME }}'
          DB_USER: 'sigma'
          DB_PASSWORD: 'sigma'
          DB_NAME: 'product_management_system'
          SESSION_SECRET: 'dev-secret-key-2025'
          EMAIL_USER: 'priyanshu17ks.edu@gmail.com'
          EMAIL_PASS: 'bztn fcvu zaig dztn'
          ADMIN_EMAIL: 'priyanshu17ks@gmail.com'
        
        beta_settings:
          cloud_sql_instances: ${{ env.PROJECT_ID }}:us-central1:${{ env.INSTANCE_NAME }}
        
        automatic_scaling:
          min_instances: 1
          max_instances: 2
          target_cpu_utilization: 0.65
        
        handlers:
        - url: /.*
          script: auto
          secure: always
        EOF
        
        # Deploy with retry logic
        MAX_RETRIES=3
        RETRY_COUNT=0
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          echo "Deployment attempt $((RETRY_COUNT + 1))..."
          
          if gcloud app deploy app-dev.yaml \
            --version=dev-$(date +%Y%m%d-%H%M%S) \
            --no-promote \
            --quiet \
            --project=${{ env.PROJECT_ID }}; then
            echo "âœ… Deployment successful!"
            break
          else
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "âš ï¸ Deployment failed, retrying in 30 seconds..."
              sleep 30
            else
              echo "âŒ Deployment failed after $MAX_RETRIES attempts"
              exit 1
            fi
          fi
        done
          
    - name: ğŸŒ Get deployment URL
      run: |
        DEV_URL=$(gcloud app browse --service=dev --no-launch-browser)
        echo "ğŸŒ Development URL: $DEV_URL"
        echo "dev_url=$DEV_URL" >> $GITHUB_OUTPUT

  # Deploy to Staging (on final-monitor1 branch)
  deploy-staging:
    name: ğŸ­ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, validate-schema, check-secrets]
    if: github.ref == 'refs/heads/final-monitor1' && github.event_name == 'push' && needs.check-secrets.outputs.secrets-available == 'true'
    environment: staging
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci --only=production
      
    - name: ğŸ”§ Setup environment variables
      run: |
        echo "NODE_ENV=staging" >> .env
        echo "DB_HOST=/cloudsql/${{ env.PROJECT_ID }}:us-central1:${{ env.INSTANCE_NAME }}" >> .env
        # Use default credentials if secrets are not set
        echo "DB_USER=sigma" >> .env
        echo "DB_PASSWORD=sigma" >> .env
        echo "DB_NAME=product_management_system" >> .env
        
    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
        
    - name: â˜ï¸ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        
    - name: ğŸš€ Deploy to App Engine Staging
      run: |
        # Create staging app.yaml
        cp app.yaml app-staging.yaml
        sed -i 's/service: default/service: staging/' app-staging.yaml
        
        gcloud app deploy app-staging.yaml \
          --version=staging-$(date +%Y%m%d-%H%M%S) \
          --promote \
          --stop-previous-version \
          --quiet

  # Deploy to Production (on main branch)
  deploy-production:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, validate-schema, check-secrets]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.check-secrets.outputs.secrets-available == 'true'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci --only=production
      
    - name: ğŸ”§ Setup environment variables
      run: |
        echo "NODE_ENV=production" >> .env
        echo "DB_HOST=/cloudsql/${{ env.PROJECT_ID }}:us-central1:${{ env.INSTANCE_NAME }}" >> .env
        # Use default credentials if secrets are not set
        echo "DB_USER=sigma" >> .env
        echo "DB_PASSWORD=sigma" >> .env
        echo "DB_NAME=product_management_system" >> .env
        
    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
        
    - name: â˜ï¸ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        
    - name: ğŸš€ Deploy to App Engine Production
      run: |
        gcloud app deploy app.yaml \
          --version=prod-$(date +%Y%m%d-%H%M%S) \
          --promote \
          --stop-previous-version \
          --quiet
          
    - name: ğŸŒ Get production URL
      run: |
        PROD_URL=$(gcloud app browse --no-launch-browser)
        echo "ğŸŒ Production URL: $PROD_URL"
        echo "prod_url=$PROD_URL" >> $GITHUB_OUTPUT

  # Health Check after deployment
  health-check:
    name: ğŸ©º Health Check
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ©º Health Check - Production
      run: |
        echo "Performing health check on production..."
        PROD_URL="https://${{ env.PROJECT_ID }}.uc.r.appspot.com"
        
        # Wait for deployment to be ready
        sleep 30
        
        # Check if the app responds
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$PROD_URL" || echo "000")
        
        if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "302" ]; then
          echo "âœ… Health check passed! App is responding (Status: $HTTP_STATUS)"
        else
          echo "âŒ Health check failed! App is not responding (Status: $HTTP_STATUS)"
          exit 1
        fi

  # Database Migration (Manual trigger)
  migrate-database:
    name: ğŸ—„ï¸ Database Migration
    runs-on: ubuntu-latest
    needs: [check-secrets]
    if: github.event_name == 'workflow_dispatch' && needs.check-secrets.outputs.secrets-available == 'true'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
        
    - name: â˜ï¸ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        
    - name: ğŸ—„ï¸ Run Database Migration
      run: |
        echo "Running database migration..."
        chmod +x scripts/migrate-database.sh
        ./scripts/migrate-database.sh
        
    - name: ğŸ§ª Run Database Setup
      run: |
        echo "Setting up database schema..."
        node setup-db.js

  # Security Scan
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”’ Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“„ Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
